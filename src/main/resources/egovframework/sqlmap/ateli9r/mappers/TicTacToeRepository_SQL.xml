<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="egovframework.ateli9r.tictactoe.repos.TicTacToeRepository">
    <!-- UserInfoRecord -->
    <resultMap id="UserInfoRecordMap" type="egovframework.ateli9r.tictactoe.typedef.domain.UserInfoRecord">
        <result property="userId" column="userId"/>
        <result property="nickname" column="nickname"/>
        <result property="email" column="email"/>
        <result property="total" column="total"/>
        <result property="wins" column="wins"/>
        <result property="losses" column="losses"/>
        <result property="draws" column="draws"/>
    </resultMap>

    <!-- GameRoomRecord -->
    <resultMap id="GameRoomRecordMap" type="egovframework.ateli9r.tictactoe.typedef.domain.GameRoomRecord">
        <result property="gameId" column="gameId"/>
        <result property="ownerId" column="ownerId"/>
        <result property="chngrId" column="chngrId"/>
        <result property="status" column="status"/>
        <result property="board" column="board"/>
    </resultMap>

    <!-- boolean login(@Param("userId") String userId, @Param("userPw") String userPw); -->
    <select id="login" resultType="boolean">
        SELECT COUNT(*) = 1
        FROM `t_user`
        WHERE `user_id` = #{userId}
        AND `user_pw` = #{userPw}
    </select>

    <!-- UserInfoRecord getUserInfo(@Param("userId") String userId); -->
    <select id="getUserInfo" resultMap="UserInfoRecordMap">
        SELECT u.`user_id` userId,
            u.`nickname`,
            u.`email`,
            ifnull(r.`total`, 0) total,
            ifnull(r.`wins`, 0) wins,
            ifnull(r.`losses`, 0) losses,
            ifnull(r.`draws`, 0) draws
        FROM `t_user` u
        LEFT JOIN `t_rank` r ON u.`user_id` = r.`user_id`
        WHERE u.`user_id` = #{userId}
    </select>

    <!-- int signUp(SignUpFormDto request); -->
    <insert id="signUp" parameterType="egovframework.ateli9r.tictactoe.typedef.dto.SignUpFormDto">
        INSERT INTO `t_user` (`user_id`, `user_pw`, `nickname`, `email`)
        VALUES (#{userId}, #{userPw}, #{nickname}, #{email})
    </insert>

    <!-- int createGame(CreateGameDto request); -->
    <insert id="createGame" parameterType="egovframework.ateli9r.tictactoe.typedef.dto.CreateGameDto">
        INSERT INTO `t_game_room` (`owner_id`, `status`, `board`)
        VALUES (#{ownerId}, 'W', '.........')
    </insert>

    <!-- int joinGame(JoinGameDto request); -->
    <update id="joinGame" parameterType="egovframework.ateli9r.tictactoe.typedef.dto.JoinGameDto">
        UPDATE `t_game_room`
        SET `chngr_id` = #{chngrId}, `status` = 'P1'
        WHERE `game_id` = #{gameId} AND `status` = 'W'
    </update>

    <!-- List<GameRoomRecord> listGameRoom(); -->
    <select id="listGameRoom" resultMap="GameRoomRecordMap">
        SELECT `game_id`, `owner_id`, `chngr_id`, `status`, `board`
        FROM `t_game_room`
    </select>

    <!-- GameRoomRecord getGameRoom(int gameId); -->
    <select id="getGameRoom" resultMap="GameRoomRecordMap">
        SELECT `game_id`, `owner_id`, `chngr_id`, `status`, `board`
        FROM `t_game_room`
        WHERE `game_id` = #{gameId}
    </select>

    <!-- List<UserInfoRecord> listGameRank(); -->
    <select id="listGameRank" resultMap="UserInfoRecordMap">
        SELECT
            u.`user_id`, u.`nickname`, u.`email`,
            ifnull(r.`total`, 0) total, ifnull(r.`wins`, 0) wins, ifnull(r.`losses`, 0) losses, ifnull(r.`draws`, 0) draws
        FROM `t_user` u
        LEFT JOIN `t_rank` r ON u.`user_id` = r.`user_id`
        ORDER BY r.`wins` DESC, r.`losses` ASC, r.`total` DESC
    </select>

    <!-- int updateGame(GameRoomRecord updateGameRoom); -->
    <update id="updateGame" parameterType="egovframework.ateli9r.tictactoe.typedef.domain.GameRoomRecord">
        UPDATE `t_game_room`
        SET `owner_id` = #{ownerId},
            `chngr_id` = #{chngrId},
            `status` = #{status},
            `board` = #{board}
        WHERE `game_id` = #{gameId}
    </update>

    <!-- int deleteTestData(String key); -->
    <delete id="deleteTestData">
        <choose>
            <when test='key == "signUp"'>
                delete from `t_user` where `user_id` = 'new_user'
            </when>
        </choose>
    </delete>

    <!-- int updateTestData(String key); -->
    <update id="updateTestData">
        <choose>
            <when test='key == "joinGame"'>
                UPDATE `t_game_room` SET
                    `chngr_id` = NULL,
                    `status` = 'W'
                WHERE `game_id` = 1
            </when>
            <when test='key == "updateGame"'>
                UPDATE `t_game_room` SET
                    `status` = 'P1',
                    `board` = '....O....'
                WHERE `game_id` = 1
            </when>
        </choose>
    </update>

    <!-- int insertTestData(String key); -->
    <insert id="insertTestData">
        <choose>
            <when test='key == "foobar"'>
                insert into ...
            </when>
        </choose>
    </insert>

</mapper>
